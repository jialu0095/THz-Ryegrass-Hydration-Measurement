import numpy as np
import matplotlib.pyplot as plt
import serial
from terasense import processor
import terasense.worker
import numpy as np
import matplotlib.pyplot as plt
from scipy.optimize import curve_fit

def attenuation(x, I0):
    print(I0)
    return I0*10**(-x/10)

# 25cm
x_data=[0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 17.0, 18.0, 19.0, 20.0, 21.0, 22.0, 23.0, 24.0, 25.0, 26.0, 27.0, 28.0, 29.0, 30.0, 31.0, 32.0, 33.0, 34.0, 35.0, 36.0, 37.0, 38.0, 39.0]
y_data=[0.4551812065972223, 0.502463107638889, 0.5412746853298612, 0.5728908962673611, 0.5972981770833333, 0.6159274631076389, 0.63017578125, 0.6401109483506944, 0.64207763671875, 0.6291720920138889, 0.5907199435763889, 0.5183525933159723, 0.4249871148003472, 0.338385009765625, 0.2682420518663194, 0.21260036892361112, 0.16864827473958333, 0.13399183485243057, 0.1061801486545139, 0.08414849175347222, 0.06671278211805556, 0.05311550564236111, 0.04212917751736111, 0.03336520724826389, 0.026624213324652774, 0.021065266927083333, 0.016702609592013886, 0.013359239366319445, 0.01069607204861111, 0.008057996961805555, 0.006489393446180556, 0.005180528428819445, 0.004325358072916666, 0.003471544053819444, 0.0026869032118055553, 0.002005343967013889, 0.0013943142361111114, 0.001376681857638889, 0.0009277343749999998, 0.000600857204861111]
# # 45 cm
# x_data=[0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 17.0, 18.0, 19.0, 20.0, 21.0, 22.0, 23.0, 24.0, 25.0, 26.0, 27.0, 28.0, 29.0, 30.0, 31.0, 32.0, 33.0, 34.0, 35.0, 36.0, 37.0, 38.0, 39.0]
# y_data=[0.6232927322387695, 0.6355785369873046, 0.6388545989990234, 0.6290347099304199, 0.5949654579162598, 0.5338634490966797, 0.4521848678588867, 0.36731748580932616, 0.2938066482543945, 0.2342385292053223, 0.18667936325073245, 0.1486989974975586, 0.11814422607421876, 0.09367237091064454, 0.07441024780273438, 0.05898561477661132, 0.046751403808593744, 0.037114715576171874, 0.029493522644042966, 0.02339658737182617, 0.018571567535400388, 0.014665317535400391, 0.011563682556152343, 0.009183788299560548, 0.007279586791992188, 0.005743885040283203, 0.004498004913330078, 0.0035746574401855466, 0.002884292602539062, 0.002207374572753906, 0.0017794609069824217, 0.0014044761657714842, 0.0011200904846191406, 0.0009056091308593749, 0.0007478713989257813, 0.0006472587585449219, 0.0005612373352050781, 0.00048675537109375003, 0.0004952430725097656, 0.0004253387451171875]


p0=1
start_index=11
popt,pcov=curve_fit(attenuation, x_data[start_index:-1], y_data[start_index:-1],p0)
print('popt:', popt)
x=np.linspace(0,40,100)
fit=attenuation(x,popt[0])

fig = plt.figure(1,facecolor="white",figsize=(8,8))
ax0 = fig.add_subplot(111)
ax0.plot(x_data,y_data,'k.')
ax0.plot(x_data[start_index:-1],y_data[start_index:-1],'r.')
ax0.plot(x,fit,'r')
plt.ylim([0,1])
plt.show()